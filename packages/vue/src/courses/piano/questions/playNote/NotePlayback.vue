<template>
  <div data-viewable="NotePlayback">
    <div class="text-h4">
      Play the note: <span class="font-weight-bold">{{ note }}</span>
    </div>

    <svg
      v-if="graded"
      id="svg8"
      width="300px"
      height="auto"
      xmlns:dc="http://purl.org/dc/elements/1.1/"
      xmlns:cc="http://creativecommons.org/ns#"
      xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
      xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
      sodipodi:docname="keys.svg"
      inkscape:version="1.0rc1 (09960d6f05, 2020-04-09)"
      version="1.1"
      viewBox="0 0 175.24936 73.594925"
    >
      <defs id="defs2" />
      <sodipodi:namedview
        id="base"
        inkscape:window-maximized="1"
        inkscape:window-y="726"
        inkscape:window-x="1491"
        inkscape:window-height="1321"
        inkscape:window-width="2400"
        showborder="false"
        showgrid="false"
        inkscape:document-rotation="0"
        inkscape:current-layer="layer1"
        inkscape:document-units="mm"
        inkscape:cy="255.88343"
        inkscape:cx="754.94284"
        inkscape:zoom="0.98994949"
        inkscape:pageshadow="2"
        inkscape:pageopacity="0.0"
        borderopacity="1.0"
        bordercolor="#666666"
        pagecolor="#ffffff"
      />
      <metadata id="metadata5">
        <rdf:RDF>
          <cc:Work rdf:about="">
            <dc:format>image/svg+xml</dc:format>
            <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
            <dc:title></dc:title>
          </cc:Work>
        </rdf:RDF>
      </metadata>
      <g id="layer1" transform="translate(167.75219,-151.96011)" inkscape:groupmode="layer" inkscape:label="Layer 1">
        <rect
          id="rect845"
          y="152.19064"
          x="-150.12129"
          height="73.220116"
          width="17.486626"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
        />
        <rect
          id="rect845-9"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-132.63466"
          y="152.19064"
        />
        <rect
          id="rect845-6"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-115.14803"
          y="152.19064"
        />
        <rect
          id="rect845-0"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-45.20153"
          y="152.19064"
        />
        <rect
          id="rect845-92"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-80.174782"
          y="152.19064"
        />
        <rect
          id="rect845-3"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-62.688156"
          y="152.19064"
        />
        <rect
          id="rect845-4"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-97.661407"
          y="152.19064"
        />
        <rect
          id="rect845-30"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="17.486626"
          height="73.220116"
          x="-27.714905"
          y="152.10745"
        />
        <rect
          id="rect898"
          ry="0"
          y="152.10744"
          x="-138.43532"
          height="54.415863"
          width="10.466455"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
        />
        <rect
          id="rect898-3"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="10.466455"
          height="54.415863"
          x="-120.84978"
          y="152.10744"
          ry="0"
        />
        <rect
          id="rect898-7"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="10.466455"
          height="54.415863"
          x="-85.678711"
          y="152.10744"
          ry="0"
        />
        <rect
          id="rect898-8"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="10.466455"
          height="54.415863"
          x="-68.09317"
          y="152.10744"
          ry="0"
        />
        <rect
          id="rect898-1"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="10.466455"
          height="54.415863"
          x="-50.507633"
          y="152.10744"
          ry="0"
        />
        <rect
          id="rect845-30-1"
          y="152.10745"
          x="-10.228278"
          height="73.220116"
          width="17.486626"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
        />
        <rect
          id="rect845-30-9"
          y="152.10744"
          x="-167.60791"
          height="73.220116"
          width="17.486626"
          style="
            fill: #ffffff;
            fill-opacity: 0;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
        />
        <rect
          id="rect898-4"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="10.466455"
          height="54.415863"
          x="-15.336554"
          y="152.10744"
          ry="0"
        />
        <rect
          id="rect898-74"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="4.4679713"
          height="54.415863"
          x="-167.60791"
          y="152.10744"
          ry="0"
        />
        <rect
          id="rect898-10"
          style="
            fill: #000000;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.79375;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          width="5.1863246"
          height="54.507248"
          x="2.2092075"
          y="152.06175"
          ry="0"
        />
      </g>
    </svg>
  </div>
</template>

<script lang="ts">
import { defineComponent, ref, computed, PropType, onMounted } from 'vue';
import { useViewable, useQuestionView } from '@/base-course/CompositionViewable';
import SkMidi, { eventsToSyllableSequence, SyllableSequence } from '../../utility/midi';
import { PlayNote } from '.';
import moment from 'moment';
import { ViewData } from '@/base-course/Interfaces/ViewData';

export default defineComponent({
  name: 'NotePlayback',

  components: {},

  props: {
    data: {
      type: Array as PropType<ViewData[]>,
      required: true,
    },
    modifyDifficulty: {
      type: Number,
      required: false,
      default: 0,
    },
  },

  setup(props, { emit }) {
    const viewableUtils = useViewable(props, emit, 'NotePlayback');
    const questionUtils = useQuestionView<PlayNote>(viewableUtils, props.modifyDifficulty);

    // State
    const midi = ref<SkMidi>();
    const initialized = ref(false);
    const recording = ref(false);
    const playbackProgress = ref(0);
    const playbackStartTime = ref(moment.utc());
    const attempts = ref(0);
    const gradedSeq = ref<SyllableSequence>(eventsToSyllableSequence([]));
    const graded = ref(false);
    const inputSeq = ref<SyllableSequence>(eventsToSyllableSequence([]));
    const note = ref('');

    // Initialize question
    questionUtils.question.value = new PlayNote(props.data);

    // Computed
    const question = computed(() => new PlayNote(props.data));

    // Methods
    const record = () => {
      midi.value?.record();
      recording.value = true;

      // attach listeners
      midi.value?.addNoteonListenter((e) => {
        inputSeq.value.append(e);
      });

      midi.value?.addNoteoffListenter(() => {
        if (midi.value?.recording?.length && midi.value?.recording?.length >= 2) {
          submit();
        }
      });
    };

    const play = () => {
      midi.value?.stopRecording();
      midi.value?.eraseRecording();
      playbackStartTime.value = moment.utc();
      recording.value = false;
      playbackProgress.value = 0;

      record();
    };

    const submit = () => {
      if (!midi.value?.recording) return false;

      inputSeq.value = eventsToSyllableSequence([]);

      if (!questionUtils.submitAnswer(midi.value.recording).isCorrect) {
        attempts.value++;
        graded.value = true;
        if (attempts.value < questionUtils.maxAttemptsPerView.value) {
          play();
        }
        return false;
      }
      return true;
    };

    // Lifecycle
    onMounted(async () => {
      try {
        midi.value = await SkMidi.instance();
        note.value = question.value.note;
        play();
        initialized.value = true;
      } catch (error) {
        viewableUtils.logger.error('Failed to initialize MIDI:', error);
      }
    });

    return {
      ...viewableUtils,
      ...questionUtils,
      initialized,
      recording,
      inputSeq,
      gradedSeq,
      graded,
      note,
      attempts,
    };
  },
});
</script>

<style lang="css">
@keyframes progress {
  0% {
    width: 0%;
  }

  100% {
    width: 100%;
  }
}

.progressContainer {
  background-color: #eee;
  height: 5px;
}

#progress {
  background-color: blue;
  width: 100%;
  height: 5px;
  animation-timing-function: linear;
}

.hidden {
  opacity: 0;
}
</style>
